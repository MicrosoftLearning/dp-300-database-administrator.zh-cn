---
lab:
  title: 实验室 13 - 部署自动化 Runbook 来自动重新生成索引
  module: Automate database tasks for Azure SQL
---

# 部署自动化 Runbook 来自动重新生成索引

预计时间：30 分钟

你已被聘用为高级数据库管理员，帮助自动执行数据库管理的日常操作。 此自动化旨在帮助确保 AdventureWorks 数据库持续以峰值性能运行，并提供基于特定条件发出警报的方法。 AdventureWorks 在基础结构即服务 (IaaS) 和平台即服务 (PaaS) 产品/服务中都使用 SQL Server。

> &#128221; 这些练习可能要求复制粘贴 T-SQL 代码并使用现有的 SQL 资源。 在执行代码之前，请验证代码是否已正确复制。

## 设置环境

如果实验室虚拟机已提供并预配置，则应在 **C:\LabFiles** 文件夹中找到已准备好的实验室文件。 *花点时间检查，如果文件已存在，请跳过本部分*。 但是，如果使用自己的计算机或缺少实验室文件，则需要从 *GitHub* 克隆它们才能继续。

1. 如果未提供实验室虚拟机或本地计算机，请启动 Visual Studio Code 会话。

1. 打开命令面板 (Ctrl+Shift+P)，然后键入 **Git: Clone**。 选择 **Git: Clone** 选项。

1. 将以下 URL 粘贴到**存储库 URL**字段中，然后选择 **Enter**。

    ```url
    https://github.com/MicrosoftLearning/dp-300-database-administrator.git
    ```

1. 将存储库保存到实验室虚拟机上的 **C:\LabFiles** 文件夹，如果没有提供本地计算机，则保存到本地计算机上的相应文件夹（如果文件夹不存在，则创建该文件夹）。

## 在 Azure 中设置 SQL Server

登录到 Azure 并检查是否已在 Azure 中运行现有的 Azure SQL Server 实例。 *如果已在 Azure 中运行 SQL Server 实例，请跳过本部分*。

1. 如果未提供实验室虚拟机或本地计算机，请启动 Visual Studio Code 会话，然后从上一部分导航到克隆的存储库。

1. 右键单击 **/Allfiles/Labs** 文件夹，然后选择“**在集成终端中打开**”。

1. 使用 Azure CLI 连接到 Azure。 输入以下命令并选择 **Enter**。

    ```bash
    az login
    ```

    > &#128221; 请注意，浏览器窗口将打开。 使用 Azure 凭据登录。

1. 登录到 Azure 后，可以创建资源组（如果尚不存在），并在该资源组下创建 SQL Server 和数据库。 输入以下命令并选择 **Enter**。 *完成该脚本需要几分钟时间。*

    ```bash
    cd ./Setup
    ./deploy-sql-database.ps1
    ```

    > &#128221; 请注意，默认情况下，此脚本将创建名为 **contoso-rg** 的资源组，或使用名称以 *contoso-rg* 开头的资源（如果存在）。 默认情况下，它还会在**美国西部 2** 区域 (westus2) 上创建所有资源。 最后，它将为 **SQL 管理员密码生成随机 12 个字符的密码**。 可以通过将一个或多个参数 **-rgName**、**-location** 和 **-sqlAdminPw** 与自己的值一起使用来更改这些值。 密码必须满足 Azure SQL 密码复杂性要求，长度至少为 12 个字符，并且至少包含 1 个大写字母、1 个小写字母、1 个数字和 1 个特殊字符。

    > &#128221; 请注意，该脚本会将当前的公共 IP 地址添加到 SQL Server 防火墙规则。

1. 脚本完成后，它将返回资源组名称、SQL Server 名称和数据库名称，以及管理员用户名和密码。 *记下这些值，因为稍后在实验室中需要这些值*。

---

## 创建 Automation 帐户

1. 如果未提供实验室虚拟机或本地计算机，请启动浏览器会话并导航到 [https://portal.azure.com](https://portal.azure.com/)。 使用 Azure 凭据登录到门户。

1. 在 Azure 门户的搜索栏中键入“自动化”，然后在搜索结果中选择“自动化帐户”，再选择“+ 创建” 。

1. 在“创建自动化帐户”页上，输入以下信息，然后选择“查看 + 创建” 。

    - **资源组：** &lt;你的资源组&gt;
    - **自动化帐户名称：** autoAccount
    - **区域：** 使用默认区域。

1. 在“查看”页上，选择“创建”。

    > &#128221; 创建自动化帐户可能需要几分钟时间。

## 连接到现有 Azure SQL 数据库

1. 在 Azure 门户中，通过搜索“sql 数据库”导航到你的数据库。

1. 选择 SQL 数据库 **AdventureWorksLT**。

1. 在 SQL 数据库页的主部分，选择“查询编辑器(预览版)”。

1. 系统将提示输入凭据，以便使用数据库管理员帐户登录到数据库，然后选择“**确定**”。

    这将在您的浏览器中打开一个新选项卡。 选择“**添加客户端 IP**”，然后选择“**保存**”。 保存后，返回到上一个选项卡，然后再次选择“**确定**”。

    > &#128221; 可能会收到错误消息：*无法打开登录名请求的服务器“your-sql-server-name”。不允许 IP 地址为“xxx.xxx.xxx.xxx”的客户端访问服务器。* 如果是这样，则需要将当前的公共 IP 地址添加到 SQL Server 防火墙规则。

    如果需要设置防火墙规则，请执行以下步骤：

    1. 在 SQL 数据库的“**概述**”页上，选择“**设置服务器防火墙**”。
    1. 选择“**添加当前 IPv4 地址 (xxx.xxx.xxx.xxx)**”，然后选择“**保存**”。
    1. 保存后，返回到 **AdventureWorksLT** 数据库页，然后再次选择 **“查询编辑器”（预览）**。
    1. 系统将提示输入凭据，以便使用数据库管理员帐户登录到数据库，然后选择“**确定**”。

1. 在**查询编辑器（预览）** 中，选择“**打开查询**”。

1. 选择浏览*文件夹*图标并导航到 **C:\LabFiles\dp-300-database-administrator\Allfiles\Labs\Module13** 文件夹。 选择 **usp_AdaptiveIndexDefrag.sql** 文件，然后选择“**打开**”，然后选择“**确定**”。

1. 删除第 5 行和第 6 行的 **USE msdb** 和 **GO** ，然后选择“**运行**”。

1. 展开 **Stored Procedures** 文件夹以查看新创建的存储过程。

## 配置自动化帐户资产

后续步骤包括配置准备创建 Runbook 所需的资产。 然后选择自动化帐户。

1. 在 Azure 门户顶部的搜索框中，键入“**自动化**”，然后选择”**自动化帐户**“。

1. 选择已创建的 **autoAccount** 自动化帐户。

1. 在“自动化”边栏选项卡的“共享资源”部分，选择“模块”。 然后选择“浏览库”。

1. 在库中搜索 **SqlServer**。

1. 选择“**SqlServer**”，这将定向到下一个屏幕，然后选中“**选择**”按钮。

1. 在“添加模块”页面上，选择可用的最新运行时版本，然后选择“导入” 。 这会将 PowerShell 模块导入自动化帐户。

1. 需要创建凭据以安全登录到数据库。 导航到“*自动化帐户*”边栏选项卡的“**共享资源**”部分，然后选择“**凭据**”。

1. 选择“+ 添加凭据”，输入以下信息，然后选择“创建” 。

    - 名称：SQLUser
    - 用户名：sqladmin
    - 密码：&lt;输入强密码，长度为 12 个字符，包含至少 1 个大写字母、1 个小写字母、1 个数字和 1 个特殊字符。&gt;
    - 确认密码：&lt;再次键入之前输入的密码。&gt;

## 创建 PowerShell Runbook

1. 在 Azure 门户中，通过搜索“sql 数据库”导航到你的数据库。

1. 选择 SQL 数据库 **AdventureWorksLT**。

1. 在“**概述**”页上，复制 Azure SQL 数据库的“**服务器名称**”，如下所示（服务器名称应以 *dp300-lab* 开头）。 将在后续步骤中粘贴此名称。

1. 在 Azure 门户顶部的搜索框中，键入“**自动化**”，然后选择”**自动化帐户**“。

1. 选择 **autoAccount** 自动化帐户。

1. 展开到自动化帐户边栏选项卡的“**流程自动化**”部分，选择 **Runbook**。

1. 选择“+ 创建 Runbook”。

    > &#128221; 正如我们已经了解到的，请注意有两个已创建的 runbook。 这些是在自动化帐户部署期间自动创建的。

1. 输入 Runbook 名称 IndexMaintenance 和 Runbook 类型 PowerShell。 选择可用的最新运行时版本，然后选择“**查看 + 创建**”。

1. 在“**创建 Runbook**”页上，选择“**创建**”。

1. 创建 Runbook 后，将下面的 Powershell 代码片段复制并粘贴到 Runbook 编辑器中。 

    > &#128221; 在保存 Runbook 之前，请验证代码是否已正确复制。

    ```powershell
    $AzureSQLServerName = ''
    $DatabaseName = 'AdventureWorksLT'
    
    $Cred = Get-AutomationPSCredential -Name "SQLUser"
    $SQLOutput = $(Invoke-Sqlcmd -ServerInstance $AzureSQLServerName -UserName $Cred.UserName -Password $Cred.GetNetworkCredential().Password -Database $DatabaseName -Query "EXEC dbo.usp_AdaptiveIndexDefrag" -Verbose) 4>&1

    Write-Output $SQLOutput
    ```

    > &#128221; 请注意，上面的代码是一个 PowerShell 脚本，它将在 **AdventureWorksLT** 数据库上执行存储过程 **usp_AdaptiveIndexDefrag**。 该脚本使用 **Invoke-Sqlcmd** cmdlet 连接到 SQL Server 并执行存储过程。 **Get-AutomationPSCredential** cmdlet 用于检索存储在自动化帐户中的凭据。

1. 在脚本的第一行上，粘贴在上述步骤中复制的服务器名称。

1. 选择**保存**，然后选择**发布**。

1. 选择“**是**”以确认发布操作。

1. *IndexMaintenance* Runbook 现已发布。

## 为 Runbook 创建计划

接下来将安排定期执行 Runbook。

1. 在“资源”下，在 IndexMaintenance Runbook 的左侧导航栏中，选择“计划”  。 

1. 选择“+ 添加计划”。

1. 选择“将计划链接到 Runbook”。****

1. 选择“+ 添加计划”。

1. 输入以下信息，然后选择“**创建**”。

    - **名称：** DailyIndexDefrag
    - **说明：** AdventureWorksLT 数据库的每日索引碎片整理。
    - **开始时间：** 上午 4:00（第二天）
    - **时区：**&lt;选择与位置匹配的时区&gt;
    - **重复周期：** 定期
    - **执行间隔：** 1 天
    - **设置到期时间：** 无

    > &#128221; 请注意，开始时间设置为第二天凌晨 4:00。 将时区设置为本地的时区。 将“重复周期”设置为每天一次。 永不过期。

1. 选择“创建”，然后选择“确定”。

1. 计划现已创建并链接到 Runbook。 选择“确定”****。

Azure 自动化提供基于云的自动化，还提供配置服务来支持 Azure 环境和非 Azure 环境之间的一致管理。

---

## 清理资源

如果不将 Azure SQL Server 用于任何其他目的，则可以清理在此实验室中创建的资源。

### 删除资源组

如果为此实验室创建了一个新的资源组，则可以删除资源组以移除在此实验室中创建的所有资源。

1. 在 Azure 门户中，从左侧导航窗格中选择“**资源组**”，或在搜索栏中搜索“**资源组**”，并从结果中选择资源组。

1. 转到为此实验室所创建的资源组。 资源组将包含在此实验室中包含的 Azure SQL 服务器和其他资源。

1. 在顶部菜单中选择“删除资源组”。

1. 在“**删除资源组**”对话框中，输入资源组的名称进行确认，然后选择“**删除**”。

1. 等待资源组被删除。

1. 关闭 Azure 门户。

### 仅删除实验室资源

如果未为此实验室创建新的资源组，并且想要使资源组及其以前的资源保持不变，仍可以删除在此实验室中创建的资源。

1. 在 Azure 门户中，从左侧导航窗格中选择“**资源组**”，或在搜索栏中搜索“**资源组**”，并从结果中选择资源组。

1. 转到为此实验室所创建的资源组。 资源组将包含在此实验室中包含的 Azure SQL 服务器和其他资源。

1. 选择前面在实验室中指定的 SQL Server 名称为前缀的所有资源。

1. 从顶部菜单中选择**删除**。

1. 在“**删除资源**”对话框中，键入“**删除**”并选择“**删除**”。

1. 再次选择“**删除**”，确认删除资源。

1. 等待资源删除完毕。

1. 关闭 Azure 门户。

### 删除 LabFiles 文件夹

如果为此实验室创建了一个新的 LabFiles 文件夹，并且不再需要它，则可以删除 LabFiles 文件夹以移除在此实验室中创建的所有文件。

1. 如果未提供实验室虚拟机或本地计算机，请打开文件资源管理器并导航到 **C:\\** 驱动器。
1. 右键单击 **LabFiles** 文件夹，然后选择“**删除**”。
1. 选择“**是**”，确认删除文件夹。

---

你已成功完成本实验室。

完成本练习后，你已经自动对 SQL Server 数据库上的索引进行了碎片整理，使其在每天凌晨 4 点运行。
