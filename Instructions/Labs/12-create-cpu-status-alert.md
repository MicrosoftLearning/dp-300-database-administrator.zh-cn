---
lab:
  title: 实验室 12 - 为 SQL Server 创建 CPU 状态警报
  module: Automate database tasks for Azure SQL
---

# 在 Azure 上为 SQL Server 创建 CPU 状态警报

预计用时：20 分钟

你已被聘用为高级数据工程师，以帮助自动执行数据库管理的日常操作。 此自动化旨在帮助确保 AdventureWorks 数据库持续以峰值性能运行，并提供基于特定条件发出警报的方法。

> &#128221; 这些练习要求复制粘贴 T-SQL 代码并使用现有的 SQL 资源。 在执行代码之前，请验证代码是否已正确复制。

## 设置环境

如果实验室虚拟机已提供并预配置，则应在 **C:\LabFiles** 文件夹中找到已准备好的实验室文件。 *花点时间检查，如果文件已存在，请跳过本部分*。 但是，如果使用自己的计算机或缺少实验室文件，则需要从 *GitHub* 克隆它们才能继续。

1. 如果未提供实验室虚拟机或本地计算机，请启动 Visual Studio Code 会话。

1. 打开命令面板 (Ctrl+Shift+P)，然后键入 **Git: Clone**。 选择 **Git: Clone** 选项。

1. 将以下 URL 粘贴到**存储库 URL**字段中，然后选择 **Enter**。

    ```url
    https://github.com/MicrosoftLearning/dp-300-database-administrator.git
    ```

1. 将存储库保存到实验室虚拟机上的 **C:\LabFiles** 文件夹，如果没有提供本地计算机，则保存到本地计算机上的相应文件夹（如果文件夹不存在，则创建该文件夹）。

## 在 Azure 中设置 SQL Server

登录到 Azure 并检查是否已在 Azure 中运行现有的 Azure SQL Server 实例。 *如果已在 Azure 中运行 SQL Server 实例，请跳过本部分*。

1. 如果未提供实验室虚拟机或本地计算机，请启动 Visual Studio Code 会话，然后从上一部分导航到克隆的存储库。

1. 右键单击 **/Allfiles/Labs** 文件夹，然后选择“**在集成终端中打开**”。

1. 使用 Azure CLI 连接到 Azure。 输入以下命令并选择 **Enter**。

    ```bash
    az login
    ```

    > &#128221; 请注意，浏览器窗口将打开。 使用 Azure 凭据登录。

1. 登录到 Azure 后，可以创建资源组（如果尚不存在），并在该资源组下创建 SQL Server 和数据库。 输入以下命令并选择 **Enter**。 *完成该脚本需要几分钟时间。*

    ```bash
    cd ./Setup
    ./deploy-sql-database.ps1
    ```

    > &#128221; 请注意，默认情况下，此脚本将创建名为 **contoso-rg** 的资源组，或使用名称以 *contoso-rg* 开头的资源（如果存在）。 默认情况下，它还会在**美国西部 2** 区域 (westus2) 上创建所有资源。 最后，它将为 **SQL 管理员密码生成随机 12 个字符的密码**。 可以通过将一个或多个参数 **-rgName**、**-location** 和 **-sqlAdminPw** 与自己的值一起使用来更改这些值。 密码必须满足 Azure SQL 密码复杂性要求，长度至少为 12 个字符，并且至少包含 1 个大写字母、1 个小写字母、1 个数字和 1 个特殊字符。

    > &#128221; 请注意，该脚本会将当前的公共 IP 地址添加到 SQL Server 防火墙规则。

1. 脚本完成后，它将返回资源组名称、SQL Server 名称和数据库名称，以及管理员用户名和密码。 *记下这些值，因为稍后在实验室中需要这些值*。

---

## 当 CPU 超过平均值 80% 时，创建警报

1. 如果未提供实验室虚拟机或本地计算机，请启动浏览器会话并导航到 [https://portal.azure.com](https://portal.azure.com/)。 使用 Azure 凭据登录到门户。

1. 在 Azure 门户顶部的搜索栏中，键入“**SQL 数据库**”，然后选择“**SQL 数据库**”。 选择列出的 AdventureWorksLT 数据库名称。

1. 在 AdventureWorksLT 数据库的主边栏选项卡上，向下导航到监视部分。 选择“**警报**”。

1. 选择“创建警报规则”。

1. 在“**创建警报规则**”页中，选择“**CPU 百分比**”。

1. 在“**警报逻辑**”部分中，为“**阈值类型**”选择“**静态**”。 然后检查 **Aggregation** 类型是否为 **Average**，**Value is** 属性是否为 **Greater than**。 然后在“**阈值**”中输入值 **80**。 查看“*检查间隔*”和“*回溯周期*”值。

1. 选择“**下一步: 操作 >**”。

1. 在“操作”选项卡下，选择“创建操作组” 。

1. 在“**操作组**”屏幕上，在“**操作组名称**”和**显示名称**字段中键入“**emailgroup**”，然后选择“**下一步: 通知**”。

1. 在“通知”选项卡上，输入以下信息：

    - 通知类型：电子邮件/短信/推送/语音

        > &#128221; 选择此选项时，将显示“电子邮件/短信/推送/语音”浮出控件。 检查“电子邮件”属性并键入登录时使用的 Azure 用户名。 选择“确定”****。

    - 名称：DemoLab

1. 依次选择“查看 + 创建”、“创建”。

1. 返回“**创建警报规则**”页，选择“**下一步：详细信息**”并为警报规则指定唯一的名称。

1. 依次选择“查看 + 创建”、“创建”。

1. 有了警报，如果 CPU 使用率平均值超过 80%，则会发送电子邮件。

---

## 清理资源

如果不将 Azure SQL Server 用于任何其他目的，则可以清理在此实验室中创建的资源。

### 删除资源组

如果为此实验室创建了一个新的资源组，则可以删除资源组以移除在此实验室中创建的所有资源。

1. 在 Azure 门户中，从左侧导航窗格中选择“**资源组**”，或在搜索栏中搜索“**资源组**”，并从结果中选择资源组。

1. 转到为此实验室所创建的资源组。 资源组将包含在此实验室中包含的 Azure SQL 服务器和其他资源。

1. 在顶部菜单中选择“删除资源组”。

1. 在“**删除资源组**”对话框中，输入资源组的名称进行确认，然后选择“**删除**”。

1. 等待资源组被删除。

1. 关闭 Azure 门户。

### 仅删除实验室资源

如果未为此实验室创建新的资源组，并且想要使资源组及其以前的资源保持不变，仍可以删除在此实验室中创建的资源。

1. 在 Azure 门户中，从左侧导航窗格中选择“**资源组**”，或在搜索栏中搜索“**资源组**”，并从结果中选择资源组。

1. 转到为此实验室所创建的资源组。 资源组将包含在此实验室中包含的 Azure SQL 服务器和其他资源。

1. 选择前面在实验室中指定的 SQL Server 名称为前缀的所有资源。

1. 从顶部菜单中选择**删除**。

1. 在“**删除资源**”对话框中，键入“**删除**”并选择“**删除**”。

1. 再次选择“**删除**”，确认删除资源。

1. 等待资源删除完毕。

1. 关闭 Azure 门户。

---

你已成功完成本实验室。

当某些指标（例如数据库大小或 CPU 使用率）达到定义的阈值时，警报可以向你发送电子邮件或调用 Webhook。 你刚刚了解了如何轻松地为 Azure SQL 数据库配置警报。
